name: Cleanup Artifacts

on:
  schedule:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts older than 4 hours
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -u

          retry_gh() {
            local max=5
            local delay=2
            local n=1
            while true; do
              if "$@"; then
                return 0
              fi
              if [ "$n" -ge "$max" ]; then
                return 1
              fi
              sleep "$delay"
              n=$((n+1))
              delay=$((delay*2))
            done
          }

          cutoff=$(date -u -d '4 hours ago' +%s)

          if ! retry_gh gh api --paginate "repos/$REPO/actions/artifacts?per_page=100" \
            --jq '.artifacts[] | [.id, .name, .created_at, .expired] | @tsv' | \
          while IFS=$'\t' read -r id name created_at expired; do
            if [ "$expired" = "true" ]; then
              continue
            fi

            created_epoch=$(date -u -d "$created_at" +%s)
            if [ "$created_epoch" -lt "$cutoff" ]; then
              echo "Deleting artifact $id ($name, created: $created_at)"
              if ! retry_gh gh api -X DELETE "repos/$REPO/actions/artifacts/$id" >/dev/null; then
                echo "Warning: failed to delete artifact $id after retries"
              fi
            fi
          done; then
            echo "Warning: failed to list artifacts after retries"
          fi
