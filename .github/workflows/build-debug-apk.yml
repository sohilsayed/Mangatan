name: Quick Debug APK Build

on:
  workflow_dispatch:

jobs:
  build-debug-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Android Platform & NDK
      run: |
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-26" "build-tools;33.0.0" "ndk;26.1.10909125"
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android
    
    - name: Install cargo-apk2
      run: cargo install --git https://github.com/kolbyml/cargo-apk2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.12.0'
        cache: 'yarn'
        cache-dependency-path: 'Mangatan-WebUI/yarn.lock'
    
    - name: Prepare Assets
      run: |
        make android_webui
        make download_android_jar
        make download_android_jre
    
    - name: Build Debug APKs
      working-directory: bin/mangatan_android
      run: |
        # Setup NDK environment
        NDK_ROOT=${ANDROID_NDK_HOME}
        if [ -z "$NDK_ROOT" ]; then
          NDK_ROOT=$(ls -d /usr/local/lib/android/sdk/ndk/* | sort -V | tail -n1)
        fi
        
        TOOLCHAIN_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
        export RANLIB="$TOOLCHAIN_BIN/llvm-ranlib"
        export AR="$TOOLCHAIN_BIN/llvm-ar"
        export CC_aarch64_linux_android="$TOOLCHAIN_BIN/aarch64-linux-android30-clang"
        export CXX_aarch64_linux_android="$TOOLCHAIN_BIN/aarch64-linux-android30-clang++"
        export AR_aarch64_linux_android="$TOOLCHAIN_BIN/llvm-ar"
        
        # Build browser version (default)
        echo "üèóÔ∏è Building Browser Version..."
        cargo apk2 build
        
        # Find and copy the APK
        APK_PATH=$(find ../../target -name "*.apk" | grep "debug/apk" | head -n 1)
        mkdir -p ../../debug_apks
        cp "$APK_PATH" ../../debug_apks/mangatan-browser-debug.apk
        
        # Clean for next build
        rm -rf ../../target/debug/apk
        
        # Build native webview version
        echo "üèóÔ∏è Building Native Webview Version..."
        cargo apk2 build --features native_webview
        
        APK_PATH=$(find ../../target -name "*.apk" | grep "debug/apk" | head -n 1)
        cp "$APK_PATH" ../../debug_apks/mangatan-webview-debug.apk
    
    - name: Upload Debug APKs
      uses: actions/upload-artifact@v4
      with:
        name: mangatan-debug-apks
        path: debug_apks/*.apk
        retention-days: 7
